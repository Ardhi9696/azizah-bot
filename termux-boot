#!/data/data/com.termux/files/usr/bin/sh

termux-wake-lock
sleep 10

# Start SSH Server
sshd

# Path binary Termux
TMUX="/data/data/com.termux/files/usr/bin/tmux"
NODE="/data/data/com.termux/files/usr/bin/node"
PYTHON="/data/data/com.termux/files/usr/bin/python3"
BOT_DIR="/data/data/com.termux/files/home/Azizah-Bot"
BOT_LOG="$BOT_DIR/telebot_boot.log"
MONITOR_LOG="$BOT_DIR/monitor_root.log"
USER_SOCKET="/data/data/com.termux/files/usr/var/run/tmux-$(id -u)/default"

# Get IP
IP=$(ip -4 addr show eth0 2>/dev/null | awk '/inet /{print $2}' | cut -d/ -f1)
[ -z "$IP" ] && IP=$(ip -4 addr show wlan0 2>/dev/null | awk '/inet /{print $2}' | cut -d/ -f1)
[ -z "$IP" ] && IP="(tidak terdeteksi)"

# Waktu
NOW=$(date +'%d/%m/%Y Рђб %H:%M:%S')

# Device Info
MODEL=$(getprop ro.product.model)
ANDROID=$(getprop ro.build.version.release)
ROOT="No"
[ "$(which su 2>/dev/null)" != "" ] && ROOT="Yes"

# Internet check
PING=$(ping -c 1 -W 1 8.8.8.8 2>/dev/null | awk -F'=' '/time=/{print $4}')
[ -z "$PING" ] && PING="Offline"

# CPU Info
CPU=$(grep 'Hardware' /proc/cpuinfo | head -1 | awk -F ': ' '{print $2}')
[ -z "$CPU" ] && CPU="Unknown CPU"

LOAD=$(top -bn 1 2>/dev/null | awk '/%cpu/{print $2}' | head -1)
[ -z "$LOAD" ] && LOAD="N/A"

# RAM info
MEM_TOTAL=$(free -m | awk '/Mem/{print $2}')
MEM_USED=$(free -m | awk '/Mem/{print $3}')

# Storage info
STORAGE_FREE=$(df -h /data | awk 'NR==2{print $4}')

# Bersihkan socket tmux user yang mandek
if [ -S "$USER_SOCKET" ]; then
  $TMUX ls >/dev/null 2>&1 || rm -f "$USER_SOCKET"
fi

# TMUX SESSION (bot) - user biasa
$TMUX has-session -t telebot 2>/dev/null
SESSION_EXISTS=$?

# Start bot if not exists
if [ $SESSION_EXISTS != 0 ]; then
  $TMUX new-session -d -s telebot "cd $BOT_DIR && git pull && $PYTHON run.py" >> "$BOT_LOG" 2>&1
  BOT_STATUS="Started"
else
  BOT_STATUS="Already Running"
fi

# ­Ъцќ Start MONITOR Node.js di tmux ROOT (session: monitor) untuk akses sensor
su -c "$TMUX has-session -t monitor 2>/dev/null || \
       $TMUX new-session -d -s monitor \"cd $BOT_DIR && $NODE monitor/server.js >> $MONITOR_LOG 2>&1\""

# Telegram message
TEXT="­ЪњА <b>STB Baru Menyala</b>

­ЪќЦ№ИЈ <b>Perangkat</b>
Рђб Model: <code>$MODEL</code>
Рђб Android: <code>$ANDROID</code>
Рђб Root: <code>$ROOT</code>

­Ъїљ <b>Jaringan</b>
Рђб IP: <code>$IP</code>
Рђб SSH: ON (8022)
Рђб Ping: <code>$PING</code>

РџЎ№ИЈ <b>Bot Status</b>
Рђб Bot: <code>$BOT_STATUS</code>
Рђб Session: <code>telebot</code>

­ЪДа <b>System Info</b>
Рђб CPU: <code>$CPU</code>
Рђб Load: <code>$LOAD%</code>
Рђб RAM: <code>${MEM_USED}MB / ${MEM_TOTAL}MB</code>
Рђб Storage Free: <code>$STORAGE_FREE</code>

РЈ░ <b>Waktu</b>
$NOW
"

# Kirim Telegram
curl -s -X POST "https://api.telegram.org/bot7777245606:AAEo9fS7AH7Of9DSngYPEtfECS1Hbmh2j9Q/sendMessage" \
  -d chat_id="7088612068" \
  -d parse_mode="HTML" \
  -d text="$TEXT"

echo "[$NOW] Startup OK" >> ~/boot.log
